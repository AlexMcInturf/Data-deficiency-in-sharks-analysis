---
title: "DataDeficiency_analysis"
author: "Alex"
date: "8/29/2019"
output: word_document
---

### This is an R Markdown file that will show the annotated analysis of our data on factors contributing to data deficiency in all known shark species.

```{r}
library(xtable); library(MASS); library(tidyverse);library(lme4);library(sjPlot)
# Read in data
dd <- read.csv("DD_analysis_datafile_4.2.csv", stringsAsFactors = FALSE)
dd = dd[dd$Order != "",]
head(dd)
nrow(dd)
# Set NAs to 0
dd[is.na(dd)] = 0
table(dd$Data.Deficient)
head(dd)
summary(dd)
# Rename some columns
dd = dd %>% rename("Rep_Strategy" = "X.Reproductive.Strategy",
                             "Antarctic" = "Antartic")

class(dd$Epipelagic)
#Cleaning up depth data
# assigning values to the 5 layers of the ocean
# epipelagic - 0-200 m
# mesopelagic - 200 - 1000 m
# bathypelagic - 1,000 - 4,000 m 
# abyssopelagic - 4,000-6,000 m 

dd[dd$Epipelagic == ""] <- "0"
dd$Epipelagic <- factor(dd$Epipelagic, levels = c("0", "1"))
class(dd$Epipelagic)
dd[dd$Mesopelagic == ""] <- "0"
dd$Mesopelagic <- factor(dd$Mesopelagic, levels = c("0", "1"))
class(dd$Mesopelagic)
dd[dd$Bathypelagic == ""] <- "0"
dd$Bathypelagic <- factor(dd$Bathypelagic, levels = c("0", "1"))
class(dd$Bathypelagic)
dd[dd$Abyssopelagic == ""] <- "0"
dd$Abyssopelagic <- factor(dd$Abyssopelagic, levels = c("0", "1"))
class(dd$Abyssopelagic)


# Cleaning up fisheries data
dd$Fisheries[dd$Fisheries == "NA"] <- "Unknown"
dd$Fisheries[dd$Fisheries == ""] <- "Unknown"
dd$Fisheries <- factor(dd$Fisheries, levels = c("Unknown", "0", "1"))
table(dd$Fisheries)
# Cleaning up reproductive strategy data
dd$Rep_Strategy[dd$Rep_Strategy == ""] = "Unknown"
dd$Rep_Strategy = factor(dd$Rep_Strategy, levels = c("Unknown", "Ovoviviparous", "Viviparous", "Oviparous"))
table(dd$Rep_Strategy)
# Removing columns unused in data
dd$Benthic <- as.numeric(dd$Benthic) %>% replace_na(0)

## Check normality of size variable; needs to be log transformed
hist(dd$Size,100)
dd$log_size<- log(dd$Size) #added a column with log transformed values, which we will use in the GLM
summary(dd$log_size)
#simple look: 
#Out of 501 shark species assessed: 37.5% are classified as DD, with ~ 4% not evaluated
sum(dd$Data.Deficient==1, na.rm=T)/nrow(dd) #.375
sum(dd$Data.Deficient==0, na.rm=T)/nrow(dd) # .585

```

### After we have our superficial values describing the data, time to do some stats and visualization. What potential predictive factors are we interested in?

*Biology*  
Size  
Reproductive strategy

*Human Use*  
Human use in general (any use)  
Type of use (fisheries, gamefish, aquaculture)
Fisheries (any fishery)

*Ecology*  
Geographic range (oceans, trans-oceanic)
Latitude/temperature (tropical/temperate)  
Habitat (benthic, deepwater, pelagic, coastal, freshwater)  
Depth range (epipelagic, mesopelagic, bathypelagic, abyssopelagic)

# Potential models (both first- and second-order interactions included)  
```{r}

#First, we will look at the coefficients of every single first order variable and extract p-values to see what we are dealing with
firstorder.mod <- glm(Data.Deficient ~ Deepwater + Coastal + Pelagic + Benthic + BrackishFreshwater +
       Tropical*Temperate + 
      Pacific + Atlantic + Indian + Fisheries+
       Gamefish + Aquarium + Epipelagic + Mesopelagic + Bathypelagic +
       log_size + Rep_Strategy, data = dd, family = "binomial")
 
firstorder.mod 

### final model
secondorder.mod6 <- glm(Data.Deficient ~ 
    Coastal*Benthic*Fisheries + Deepwater*Benthic*Fisheries + BrackishFreshwater+ ## no interaction term for brackishfreshwater due to small n
Pelagic*Fisheries+
      Tropical*Temperate + 
      Pacific + Atlantic + Indian + 
      Fisheries + Gamefish + Aquarium + 
      Epipelagic + Mesopelagic + Bathypelagic +
      log_size + Rep_Strategy, data = dd, family = "binomial")

secondorder.mod6


```
### Now to visualize a coefficient plots to see what is significant!

```{r}
# # Pull out plot data
coefs1 <- plot_model(firstorder.mod, transform = NULL) 
coefs1$data %>%
  mutate(term = factor(term, levels = term)) %>%
  ggplot(aes(x = estimate,
             y = as.numeric(term),
             color = as.factor(sign(estimate)),
             alpha = as.factor(p.value < 0.05))) +
  geom_point() + 
  geom_segment(aes(x = conf.low,
                   xend  = conf.high,
                   yend = as.numeric(term))) +
  geom_vline(xintercept = 0) +
  scale_y_continuous(labels = as.character(coefs1$data$term),
                     breaks = seq(1, 21, 1)) +
  scale_alpha_discrete(range = c(.5, 1)) +
  xlab("Log Odds Ratio of Being DD (Higher Values = Greater Chance)") +
  ylab("Variables")+ ggtitle("First-order model -all n<3")


##### Chosen model
coefs2.6 <- plot_model(secondorder.mod6, transform = NULL) 
coefs2.6$data %>%
  mutate(term = factor(term, levels = term)) %>%
  ggplot(aes(x = estimate,
             y = as.numeric(term),
             color = as.factor(sign(estimate)),
             alpha = as.factor(p.value < 0.05))) +
  geom_point() + 
  geom_segment(aes(x = conf.low,
                   xend  = conf.high,
                   yend = as.numeric(term))) +
  geom_vline(xintercept = 0) +
  scale_y_continuous(labels = as.character(coefs2.6$data$term),
                     breaks = seq(1, 29, 1)) +
  scale_alpha_discrete(range = c(.5, 1)) +
  xlab("Log Odds Ratio of Being DD (Higher Values = Greater Chance)") +
  ylab("Variables")+ ggtitle("Multi-Order Model -all n<3")

```


### Let's visualize some of our our significant results
Start with making a table of the emmeans, which give us our predicted, backtransformed values of probability of DD based on the glm

```{r}

## subset coefficients by category
fullcoeffs <- summary(secondorder.mod6)$coefficients %>% as.data.frame(.) %>% rownames_to_column()
coef_conf <- confint(secondorder.mod6) %>% as.data.frame(.) %>% rownames_to_column() #error here

coef_table <- left_join(fullcoeffs, coef_conf) %>%
  rename("Coef" = "rowname")


########### Generating Estimated Marginal Mean ##########
# estimates the average value for that combination of parameters, and predicts the resulting mean for a set of specified values #

library(emmeans)

# size
logsize_means <- emmeans(firstorder.mod, ~ log_size, 
         var = "log_size", 
         at = list(log_size = seq(2, 8, by = .25)),
         type = "response")

#habitat
Brackish_means <- emmeans(firstorder.mod, ~ BrackishFreshwater,
         var = "BrackishFreshwater", 
         at = list(BrackishFreshwater = c(0,1),
         type = "response"))

library(boot)
inv.logit(-0.8435952)
inv.logit(-2.3922874)

DW_means <- emmeans(firstorder.mod, ~ Deepwater, 
         var = "Deepwater", 
         at = list(Deepwater = c(0,1),
         type = "response")) #giving probability that the animal is data deficient if benthic = 0,1 and fished


coastalfish_means <- emmeans(firstorder.mod, ~ Coastal, 
         var = "Coastal", 
         at = list(Coastal = c(0,1),
         type = "response"))

pelagicfish_means <- emmeans(firstorder.mod, ~ Pelagic, 
         var = "Pelagic", 
         at = list(Pelagic = c(0,1)),
         type = "response")


#oceans
Atlantic_means <- emmeans(firstorder.mod, ~ Atlantic, 
         var = "Atlantic", 
         at = list(Atlantic = c(0,1)),
         type = "response")

Pacific_means <- emmeans(firstorder.mod, ~ Pacific, 
         var = "Pacific", 
         at = list(Pacific = c(0,1)),
         type = "response")

Indian_means <- emmeans(firstorder.mod, ~ Indian, 
         var = "Indian", 
         at = list(Indian = c(0,1)),
         type = "response")

# depth
bathy_means <- emmeans(firstorder.mod, ~ Bathypelagic, 
         var = "Bathypelagic", 
         at = list(Bathypelagic = factor(c(0,1))),
         type = "response")

meso_means <- emmeans(firstorder.mod, ~ Mesopelagic, 
         var = "Mesopelagic", 
         at = list(Mesopelagic = factor(c(0,1))),
         type = "response")

epipelagic_means <- emmeans(firstorder.mod, ~ Epipelagic, 
         var = "Epipelagic", 
         at = list(Epipelagic = factor(c(0,1))),
         type = "response")


# tropical/temperate
temptrop_means <- emmeans(firstorder.mod, ~ Tropical*Temperate, 
         var = "Tropical*Temperate", 
         at = list(Tropical = c(0,1),
                   Temperate = c(0,1)),
         type = "response")

# coastal and deepwater alone (NOTE: all other variables are averaged; this is not affected by any other variable)
benthic_alone_means <- emmeans(firstorder.mod, ~ Benthic, 
         var = "Benthic", 
         at = list(Benthic = c(0,1)),
         type = "response")

fisheries_means <- emmeans(firstorder.mod, ~ Fisheries, 
         var = "Fisheries", 
         at = list(Fisheries = factor(c(0,1))),
         type = "response")

gamefish_means <- emmeans(firstorder.mod, ~ Gamefish, 
         var = "Gamefish", 
         at = list(Gamefish = c(0,1)),
         type = "response")

aquarium_means <- emmeans(firstorder.mod, ~ Aquarium, 
         var = "Aquarium", 
         at = list(Aquarium = c(0,1)),
         type = "response")


logsize_means
Brackish_means
DW_means
coastalfish_means
pelagicfish_means
temptrop_means
Atlantic_means
Pacific_means
Indian_means
bathy_means
meso_means
epipelagic_means
benthic_alone_means
fisheries_means
gamefish_means
aquarium_means
```

```{r}
# Plotting the size figure
data.frame(logsize_means) %>%
  ggplot(aes(x = exp(log_size), # Exponentiating log size
             y = prob)) + geom_line(color="#1F4E79")+
  geom_ribbon(aes(ymin = asymp.LCL,
              ymax = asymp.UCL),
              alpha = .2) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(plot.background=element_rect(fill = "#BDD7EE"),
  panel.background = element_rect(fill = "white"))+
xlab("Average body size (cm)") +
  ylab("Probability of Data Deficiency")


### try with new color
data.frame(logsize_means) %>%
  ggplot(aes(x = exp(log_size), # Exponentiating log size
             y = prob)) + geom_line(color="#1F4E79")+
  geom_ribbon(aes(ymin = asymp.LCL,
              ymax = asymp.UCL),
              alpha = .2) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(plot.background=element_rect(fill = "#EDD58B"),
  panel.background = element_rect(fill = "white"))+ 
xlab(" ") +
  ylab(" ")


```
