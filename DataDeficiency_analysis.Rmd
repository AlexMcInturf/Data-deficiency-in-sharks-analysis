---
title: "DataDeficiency_analysis"
author: "Alex"
date: "8/29/2019"
output: html_document
---

### This is an R Markdown file that will show the annotated analysis of our data on factors contributing to data deficiency in all known shark species.

```{r}
library(xtable); library(MASS); library(tidyverse);library(lme4);library(sjPlot)
# Read in data
dd <- read.csv("DD_analysis_datafile_3.csv", stringsAsFactors = FALSE)
dd = dd[dd$Order != "",]

# Set NAs to 0
dd[is.na(dd)] = 0
table(dd$Data.Deficient)
#head(dd)
#summary(dd)
# Rename some columns
dd = dd %>% rename("Rep_Strategy" = "X.Reproductive.Strategy",
                             "Vulnerability" = "Vulnerability..",
                             "Antarctic" = "Antartic")

class(dd$Epipelagic)
#Cleaning up depth data
# assigning values to the 5 layers of the ocean
# epipelagic - 0-200 m
# mesopelagic - 200 - 1000 m
# bathypelagic - 1,000 - 4,000 m 
# abyssopelagic - 4,000-6,000 m 

dd[dd$Epipelagic == ""] <- "0"
dd$Epipelagic <- factor(dd$Epipelagic, levels = c("0", "1"))
class(dd$Epipelagic)
dd[dd$Mesopelagic == ""] <- "0"
dd$Mesopelagic <- factor(dd$Mesopelagic, levels = c("0", "1"))
class(dd$Mesopelagic)
dd[dd$Bathypelagic == ""] <- "0"
dd$Bathypelagic <- factor(dd$Bathypelagic, levels = c("0", "1"))
class(dd$Bathypelagic)
dd[dd$Abyssopelagic == ""] <- "0"
dd$Abyssopelagic <- factor(dd$Abyssopelagic, levels = c("0", "1"))
class(dd$Abyssopelagic)


# Cleaning up fisheries data
dd$Fisheries[dd$Fisheries == "NA"] <- "Unknown"
dd$Fisheries[dd$Fisheries == ""] <- "Unknown"
dd$Fisheries <- factor(dd$Fisheries, levels = c("Unknown", "0", "1"))

# Cleaning up reproductive strategy data
dd$Rep_Strategy[dd$Rep_Strategy == ""] = "Unknown"
dd$Rep_Strategy = factor(dd$Rep_Strategy, levels = c("Unknown", "Ovoviviparous", "Viviparous", "Oviparous"))

# Removing columns unused in data
dd$Benthic <- as.numeric(dd$Benthic) %>% replace_na(0)
dd$Vulnerability <- as.numeric(dd$Vulnerability) %>% replace_na(0)

## Check normality of size variable; needs to be log transformed
hist(dd$Size,100)
dd$log_size<- log(dd$Size) #added a column with log transformed values, which we will use in the GLM

summary(dd)


#simple look: 
#Out of 501 shark species assessed: 37.5% are classified as DD, with ~ 4% not evaluated
sum(dd$Data.Deficient==1, na.rm=T)/nrow(dd) #.375
sum(dd$Data.Deficient==0, na.rm=T)/nrow(dd) # .585
```

### After we have our superficial values describing the data, time to do some stats and visualization. What potential predictive factors are we interested in?

*Biology*  
Size  
Reproductive strategy

*Human Use*  
Human use in general (any use)  
Type of use (fisheries, gamefish, aquaculture)
Fisheries (any fishery)

*Ecology*  
Geographic range (oceans, trans-oceanic)
Latitude/temperature (tropical/temperate)  
Habitat (benthic, deepwater, pelagic, coastal, freshwater)  
Depth range (epipelagic, mesopelagic, bathypelagic, abyssopelagic)


```{r}

#First, we will look at the coefficients of every single first order variable and extract p-values to see what we are dealing with
firstorder.mod <- glm(Data.Deficient ~ Deepwater + Coastal + Pelagic + Benthic + BrackishFreshwater +
      Tropical + Temperate + 
     Pacific + Atlantic + Indian + Arctic + Antarctic + Trans.oceanic +
      Fisheries + commercial + subsistence + Gamefish + Aquarium + Epipelagic + Mesopelagic + Bathypelagic + Abyssopelagic+
      log_size + Rep_Strategy, data = dd, family = "binomial")

firstorder.mod 

# considering removing abyssopelagic - n=1
firstorder.mod2 <- glm(Data.Deficient ~ Deepwater + Coastal + Pelagic + Benthic + BrackishFreshwater +
      Tropical + Temperate + 
     Pacific + Atlantic + Indian + Arctic + Antarctic + Trans.oceanic +
      Fisheries + commercial + subsistence + Gamefish + Aquarium + Epipelagic + Mesopelagic + Bathypelagic +
      log_size + Rep_Strategy, data = dd, family = "binomial")

firstorder.mod2

### note that we did try to include "Family" as a random variable; however, it was "rank deficient", which means that it was correlated with multiple other variables and therefore redundant. However, code is below

#firstorder.mod.re <- glmer(Data.Deficient ~ Deepwater + Coastal + Pelagic + Benthic + BrackishFreshwater + 
   #   Tropical + Temperate + 
    #  Global + Pacific + Atlantic + Indian + Arctic + Antarctic + Trans.oceanic +
     # Fisheries + commercial + subsistence + Gamefish + Aquarium + Vulnerability + 
      #log_size + Rep_Strategy +
       # (1|Order), data = dd, family = "binomial")


### Second order model with all potential interactions
secondorder.mod <- glm(Data.Deficient ~ Deepwater + Coastal + Pelagic + Benthic + BrackishFreshwater + Coastal*Benthic + Deepwater*Benthic + 
      Tropical + Temperate + 
      Tropical*Temperate + Pacific + Atlantic + Indian + Arctic + Trans.oceanic + Trans.oceanic*Pacific + Trans.oceanic*Atlantic + Trans.oceanic*Indian + Trans.oceanic*Arctic +
      Fisheries + commercial + subsistence + Gamefish + Aquarium + Epipelagic + Mesopelagic + Bathypelagic + Abyssopelagic+
      log_size + Rep_Strategy + Coastal*Fisheries + Pelagic*Fisheries + Benthic*Fisheries + Trans.oceanic*Fisheries, data = dd, family = "binomial")

secondorder.mod 

#removing trans-oceanic as a variable
secondorder.mod2 <- glm(Data.Deficient ~ Deepwater + Coastal + Pelagic + Benthic + BrackishFreshwater + Coastal*Benthic + Deepwater*Benthic + 
      Tropical + Temperate + 
      Tropical*Temperate + Pacific + Atlantic + Indian + Arctic + 
      Fisheries + commercial + subsistence + Gamefish + Aquarium + Epipelagic + Mesopelagic + Bathypelagic + Abyssopelagic+
      log_size + Rep_Strategy + Coastal*Fisheries + Pelagic*Fisheries + Benthic*Fisheries + Fisheries, data = dd, family = "binomial")

secondorder.mod2

#removing abyssopelagic as a variable, including first order variable transoceanic
secondorder.mod3 <- glm(Data.Deficient ~ Deepwater + Coastal + Pelagic + Benthic + BrackishFreshwater + Coastal*Benthic + Deepwater*Benthic + Trans.oceanic+
      Tropical + Temperate + 
      Tropical*Temperate + Pacific + Atlantic + Indian + Arctic + 
      Fisheries + commercial + subsistence + Gamefish + Aquarium + Epipelagic + Mesopelagic + Bathypelagic + 
      log_size + Rep_Strategy + Coastal*Fisheries + Pelagic*Fisheries + Benthic*Fisheries + Fisheries, data = dd, family = "binomial")

secondorder.mod3

#keeping abyssopelagic as a variable, including first order variable transoceanic
secondorder.mod4 <- glm(Data.Deficient ~ Deepwater + Coastal + Pelagic + Benthic + BrackishFreshwater + Coastal*Benthic + Deepwater*Benthic + Trans.oceanic+
      Tropical + Temperate + 
      Tropical*Temperate + Pacific + Atlantic + Indian + Arctic + 
      Fisheries + commercial + subsistence + Gamefish + Aquarium + Epipelagic + Mesopelagic + Bathypelagic + Abyssopelagic +
      log_size + Rep_Strategy + Coastal*Fisheries + Pelagic*Fisheries + Benthic*Fisheries + Fisheries, data = dd, family = "binomial")

secondorder.mod4

#removing abyssopelagic and transoceanic as a variable
secondorder.mod5 <- glm(Data.Deficient ~ Deepwater + Coastal + Pelagic + Benthic + BrackishFreshwater + Coastal*Benthic + Deepwater*Benthic +
      Tropical + Temperate + 
      Tropical*Temperate + Pacific + Atlantic + Indian + Arctic + 
      Fisheries + commercial + subsistence + Gamefish + Aquarium + Epipelagic + Mesopelagic + Bathypelagic + 
      log_size + Rep_Strategy + Coastal*Fisheries + Pelagic*Fisheries + Benthic*Fisheries + Fisheries, data = dd, family = "binomial")

secondorder.mod5

### removing arctic, abyssopelagic, transoceanic
secondorder.mod6 <- glm(Data.Deficient ~ Deepwater + Coastal + Pelagic + Benthic + BrackishFreshwater + Coastal*Benthic + Deepwater*Benthic +
      Tropical + Temperate + 
      Tropical*Temperate + Pacific + Atlantic + Indian + 
      Fisheries + commercial + subsistence + Gamefish + Aquarium + Epipelagic + Mesopelagic + Bathypelagic + 
      log_size + Rep_Strategy + Coastal*Fisheries + Pelagic*Fisheries + Benthic*Fisheries + Fisheries, data = dd, family = "binomial")

secondorder.mod6


```
### Now to visualize a coefficient plots to see what is significant!

```{r}
# Pull out plot data
coefs <- plot_model(firstorder.mod, transform = NULL)
# Making custom figure
coefs$data %>%
  mutate(term = factor(term, levels = term)) %>%
  # Color by sign of change, transparency by p-value
  ggplot(aes(x = estimate,
             y = as.numeric(term),
             color = as.factor(sign(estimate)),
             alpha = as.factor(p.value < 0.05))) +
  geom_point() + 
  # Add CIs around point
  geom_segment(aes(x = conf.low,
                   xend  = conf.high,
                   yend = as.numeric(term))) +
  geom_vline(xintercept = 0) +
  # Adding labelled y axis
  scale_y_continuous(labels = as.character(coefs$data$term),
                     breaks = seq(1, 25, 1)) +
  scale_alpha_discrete(range = c(.5, 1)) +
  xlab("Log Odds Ratio of Being DD (Higher Values = Greater Chance)") +
  ylab("Variables") + ggtitle("First order model")

coefs1.2 <- plot_model(firstorder.mod2, transform = NULL)

# Making custom figure
coefs1.2$data %>%
  mutate(term = factor(term, levels = term)) %>%
  ggplot(aes(x = estimate,
             y = as.numeric(term),
             color = as.factor(sign(estimate)),
             alpha = as.factor(p.value < 0.05))) +
  geom_point() + 
  geom_segment(aes(x = conf.low,
                   xend  = conf.high,
                   yend = as.numeric(term))) +
  geom_vline(xintercept = 0) +
  scale_y_continuous(labels = as.character(coefs1.2$data$term),
                     breaks = seq(1, 24, 1)) +
  scale_alpha_discrete(range = c(.5, 1)) +
  xlab("Log Odds Ratio of Being DD (Higher Values = Greater Chance)") +
  ylab("Variables") + ggtitle("First order model w/o Abyssopelagic")


############# REPEAT FOR SECOND ORDER MODEL #############

# Pull out plot data
coefs2 <- plot_model(secondorder.mod, transform = NULL) 

# Making custom figure
coefs2$data %>%
  mutate(term = factor(term, levels = term)) %>%
  ggplot(aes(x = estimate,
             y = as.numeric(term),
             color = as.factor(sign(estimate)),
             alpha = as.factor(p.value < 0.05))) +
  geom_point() + 
  geom_segment(aes(x = conf.low,
                   xend  = conf.high,
                   yend = as.numeric(term))) +
  geom_vline(xintercept = 0) +
  scale_y_continuous(labels = as.character(coefs2$data$term),
                     breaks = seq(1, 35, 1)) +
  scale_alpha_discrete(range = c(.5, 1)) +
  xlab("Log Odds Ratio of Being DD (Higher Values = Greater Chance)") +
  ylab("Variables") + ggtitle("Second Order Model - w/Transoceanic")

###### without trans-oceanic ######

# Pull out plot data
coefs2.2 <- plot_model(secondorder.mod2, transform = NULL) 
coefs2.2$data %>%
  mutate(term = factor(term, levels = term)) %>%
  ggplot(aes(x = estimate,
             y = as.numeric(term),
             color = as.factor(sign(estimate)),
             alpha = as.factor(p.value < 0.05))) +
  geom_point() + 
  geom_segment(aes(x = conf.low,
                   xend  = conf.high,
                   yend = as.numeric(term))) +
  geom_vline(xintercept = 0) +
  scale_y_continuous(labels = as.character(coefs2.2$data$term),
                     breaks = seq(1, 30, 1)) +
  scale_alpha_discrete(range = c(.5, 1)) +
  xlab("Log Odds Ratio of Being DD (Higher Values = Greater Chance)") +
  ylab("Variables")+ ggtitle("Second Order Model - w/o Transoceanic")

##### Remove abyssopelagic, keep transoceanic first order
# Pull out plot data
coefs2.3 <- plot_model(secondorder.mod3, transform = NULL) 
# Making custom figure
coefs2.3$data %>%
  mutate(term = factor(term, levels = term)) %>%
  ggplot(aes(x = estimate,
             y = as.numeric(term),
             color = as.factor(sign(estimate)),
             alpha = as.factor(p.value < 0.05))) +
  geom_point() + 
  geom_segment(aes(x = conf.low,
                   xend  = conf.high,
                   yend = as.numeric(term))) +
  geom_vline(xintercept = 0) +
  scale_y_continuous(labels = as.character(coefs2.3$data$term),
                     breaks = seq(1, 30, 1)) +
  scale_alpha_discrete(range = c(.5, 1)) +
  xlab("Log Odds Ratio of Being DD (Higher Values = Greater Chance)") +
  ylab("Variables")+ ggtitle("Second Order Model - no abyssopelagic + 1st order transoceanic")

##### Keep abyssopelagic, keep transoceanic first order
# Pull out plot data
coefs2.4 <- plot_model(secondorder.mod4, transform = NULL) 
# Making custom figure
coefs2.4$data %>%
  mutate(term = factor(term, levels = term)) %>%
  ggplot(aes(x = estimate,
             y = as.numeric(term),
             color = as.factor(sign(estimate)),
             alpha = as.factor(p.value < 0.05))) +
  geom_point() + 
  geom_segment(aes(x = conf.low,
                   xend  = conf.high,
                   yend = as.numeric(term))) +
  geom_vline(xintercept = 0) +
  scale_y_continuous(labels = as.character(coefs2.4$data$term),
                     breaks = seq(1, 31, 1)) +
  scale_alpha_discrete(range = c(.5, 1)) +
  xlab("Log Odds Ratio of Being DD (Higher Values = Greater Chance)") +
  ylab("Variables")+ ggtitle("Second Order Model - w/ abyssopelagic + 1st order transoceanic")

##### Remove abyssopelagic, remove transoceanic
# Pull out plot data
coefs2.5 <- plot_model(secondorder.mod5, transform = NULL) 
# Making custom figure
coefs2.5$data %>%
  mutate(term = factor(term, levels = term)) %>%
  ggplot(aes(x = estimate,
             y = as.numeric(term),
             color = as.factor(sign(estimate)),
             alpha = as.factor(p.value < 0.05))) +
  geom_point() + 
  geom_segment(aes(x = conf.low,
                   xend  = conf.high,
                   yend = as.numeric(term))) +
  geom_vline(xintercept = 0) +
  scale_y_continuous(labels = as.character(coefs2.5$data$term),
                     breaks = seq(1, 29, 1)) +
  scale_alpha_discrete(range = c(.5, 1)) +
  xlab("Log Odds Ratio of Being DD (Higher Values = Greater Chance)") +
  ylab("Variables")+ ggtitle("Second Order Model - no abyssopelagic or TO")

##### Remove abyssopelagic, remove transoceanic and Arctic
# Pull out plot data
coefs2.6 <- plot_model(secondorder.mod6, transform = NULL) 
# Making custom figure
coefs2.6$data %>%
  mutate(term = factor(term, levels = term)) %>%
  ggplot(aes(x = estimate,
             y = as.numeric(term),
             color = as.factor(sign(estimate)),
             alpha = as.factor(p.value < 0.05))) +
  geom_point() + 
  geom_segment(aes(x = conf.low,
                   xend  = conf.high,
                   yend = as.numeric(term))) +
  geom_vline(xintercept = 0) +
  scale_y_continuous(labels = as.character(coefs2.6$data$term),
                     breaks = seq(1, 28, 1)) +
  scale_alpha_discrete(range = c(.5, 1)) +
  xlab("Log Odds Ratio of Being DD (Higher Values = Greater Chance)") +
  ylab("Variables")+ ggtitle("Second Order Model - remove TO and all n<3")





```

# Results
*First order model*
Here we see a few significant relationships:  

*Biology*  
**Size** negative correlation with DD  
Reproductive strategy  

*Human Use*  
Human use in general (any use)  
**Type of fishery** (**commercial - negative correlation**, gamefish, aquaculture)  
Fisheries (any fishery)

*Ecology*  
**Geographic range** positive corr. with Arctic Ocean (note small sample size); negative corr. with Indian Ocean   
Latitude/temperature (tropical/temperate)  
**Habitat** (**benthic - positive correlation**, deepwater, pelagic, coastal, **freshwater - negative correlation**)  
**Depth range** (**0-200 m - negative correlation**, 201-1000 m, **1000+ m- negative correlation**)  

*Let's summarize what this all means. In general, we are seeing that larger sharks are less likely to be data deficient, as are species targeted by fisheries specifically, rather than just human use in general. In terms of habitat, sharks are less likely to be data deficient if they are found in the Indian Ocean, in freshwater, and either in the photic zone or at depths of greater than 1000 m. Note that there may be an influence of sample size in some of these cases.*  

*In contrast, highly vulnerable species are more likely to be data deficient. Sharks in the Arctic are also more likely to be data deficient, although we have a small sample size for this. Interestingly, although sharks at depths of greater than 1000 m are LESS likely to be data deficient, benthic species are likely to be. These two characteristics are not necessarily correlated, as benthic species could reside at all depths, depending on whether they are coastal or deep water.*  


# Results  
*Second order model*  
**TBD**  
See below

# Model selection  

```{r}
ic <- data.frame(Model = c("secondorder.mod", "secondorder.mod2", "secondorder.mod3", "secondorder.mod4", "firstorder.mod", "firstorder.mod2", "secondorder.mod5", "secondorder.mod6"),
AIC = c(AIC(secondorder.mod), AIC(secondorder.mod4), AIC(secondorder.mod2), AIC(secondorder.mod3), AIC(firstorder.mod), AIC(firstorder.mod2), AIC(secondorder.mod5), AIC(secondorder.mod6)),
stringsAsFactors = FALSE
)

ic <- ic[order(ic$AIC),]
ic


```
# AIC selection  
*Generally seeing three top models, all second order -*  
1) no abyssopelagic, first order transoceanic (note that transoceanic is redundant, so not using this one)  
2) no abyssopelagic or transoceanic  
3) no abyssopelagic, Arctic, or transoceanic (likely going to use this one because Arctic is still relevant potentially, with caveat of small sample size)  

```{r}
##### Chosen model
coefs2.5 <- plot_model(secondorder.mod5, transform = NULL) 
coefs2.5$data %>%
  mutate(term = factor(term, levels = term)) %>%
  ggplot(aes(x = estimate,
             y = as.numeric(term),
             color = as.factor(sign(estimate)),
             alpha = as.factor(p.value < 0.05))) +
  geom_point() + 
  geom_segment(aes(x = conf.low,
                   xend  = conf.high,
                   yend = as.numeric(term))) +
  geom_vline(xintercept = 0) +
  scale_y_continuous(labels = as.character(coefs2.5$data$term),
                     breaks = seq(1, 29, 1)) +
  scale_alpha_discrete(range = c(.5, 1)) +
  xlab("Log Odds Ratio of Being DD (Higher Values = Greater Chance)") +
  ylab("Variables")+ ggtitle("Second Order Model - no abyssopelagic or TO")
```


### Let's visualize some of our our significant results

```{r}

## subset coefficients by category
fullcoeffs <- summary(secondorder.mod3)$coefficients %>% as.data.frame(.) %>% rownames_to_column()
coef_conf <- confint(secondorder.mod3) %>% as.data.frame(.) %>% rownames_to_column() #error here

coef_table <- left_join(fullcoeffs, coef_conf) %>%
  rename("Coef" = "rowname")

#size_coeffs <- fullcoeffs[c("log_size"),]
#size_coeffs
#vuln_coeffs <- plogis(fullcoeffs[c("Vulnerability"),])

########### Evan's Help ####
library(emmeans)

logsize_means <- emmeans(secondorder.mod3, ~ log_size, 
         var = "log_size", 
         at = list(log_size = seq(2, 8, by = .25)),
         type = "response")

# Plotting the figure
data.frame(logsize_means) %>%
  ggplot(aes(x = exp(log_size), # Exponentiating log size
             y = prob)) +
  geom_ribbon(aes(ymin = asymp.LCL,
              ymax = asymp.UCL),
              alpha = .2) +
  geom_line() + xlab("Average body size (cm)") +
  ylab("Probability")
 
