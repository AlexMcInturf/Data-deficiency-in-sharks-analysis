---
title: "DataDeficiency_analysis"
author: "Alex"
date: "8/29/2019"
output: pdf_document
---

### This is an R Markdown file that will show the annotated analysis of our data on factors contributing to data deficiency in all known shark species.

```{r}
library(tidyverse);library(lme4);library(sjPlot)
# Read in data
dd <- read.csv("DD_analysis_datafile_2.csv", stringsAsFactors = FALSE)
dd = dd[dd$Order != "",]

# Set NAs to 0
dd[is.na(dd)] = 0
table(dd$Data.Deficient)

# Rename some columns
dd = dd %>% rename("Rep_Strategy" = "X.Reproductive.Strategy",
                             "Vulnerability" = "Vulnerability..",
                             "Antarctic" = "Antartic", "D1" = "Depth.0.200.", "D2"="Depth.201.1000.", "D3"="Depth.1000..")

# Cleaning up human uses data (binary = yes or no)
dd$Human.Uses <- ifelse (dd$Human.Uses == "", 0, 1)
table(dd$Human.Uses) 
dd$Human.Uses <- factor(dd$Human.Uses, levels = c("0", "1"))

#Cleaning up depth data
dd$D1[dd$D1 == ""] <- "0"# D1 corresponds to the 0-200 m depth range
dd$D1 <- factor(dd$D1, levels = c("0", "1"))
class(dd$D1) 
dd$D2[dd$D2 == ""] <- "0" #D2 corresponds to the 201-1000 m depth range
dd$D2 <- factor(dd$D2, levels = c("0", "1"))
class(dd$D2)
dd$D3[dd$D3 == ""] <- "0"
dd$D3 <- factor(dd$D3, levels = c("0", "1"))
class(dd$D3)

# Cleaning up fisheries data
dd$Fisheries[dd$Fisheries == "NA"] <- "Unknown"
dd$Fisheries[dd$Fisheries == ""] <- "Unknown"
dd$Fisheries <- factor(dd$Fisheries, levels = c("Unknown", "0", "1"))

# Cleaning up reproductive strategy data
dd$Rep_Strategy[dd$Rep_Strategy == ""] = "Unknown"
dd$Rep_Strategy = factor(dd$Rep_Strategy, levels = c("Unknown", "Ovoviviparous", "Viviparous", "Oviparous"))

# Removing columns unused in data
dd$Benthic <- as.numeric(dd$Benthic) %>% replace_na(0)
dd$Vulnerability <- as.numeric(dd$Vulnerability) %>% replace_na(0)

## Check normality of size variable; needs to be log transformed
hist(dd$Size,100)
dd$log_size<- log(dd$Size) #added a column with log transformed values, which we will use in the GLM

summary(dd)


#simple look: 
#Out of 501 shark species assessed: 37.5% are classified as DD, with ~ 4% not evaluated
sum(dd$Data.Deficient==1, na.rm=T)/nrow(dd) #.375
sum(dd$Data.Deficient==0, na.rm=T)/nrow(dd) # .585
```

### After we have our superficial values describing the data, time to do some stats and visualization. What potential predictive factors are we interested in?

*Biology*  
Size  
Reproductive strategy

*Human Use*  
Human use in general (any use)  
Vulnerability  
Type of use (commercial, gamefish, aquaculture)  

*Ecology*  
Geographic range  
Latitude/temperature (tropical/temperate)  
Habitat (benthic, deepwater, pelagic, coastal, freshwater)  
Depth range  


```{r}

#First, we will look at the coefficients of every single first order variable and extract p-values to see what we are dealing with
firstorder.mod <- glm(Data.Deficient ~ Deepwater + Coastal + Pelagic + Benthic + BrackishFreshwater +
      Tropical + Temperate + 
      Global + Pacific + Atlantic + Indian + Arctic + Antarctic + Trans.oceanic +
      Fisheries + commercial + subsistence + Gamefish + Aquarium + Vulnerability + Human.Uses+ D1 + D2 + D3 +
      log_size + Rep_Strategy, data = dd, family = "binomial")

firstorder.mod 

### note that we did try to include "Family" as a random variable; however, it was "rank deficient", which means that it was correlated with multiple other variables and therefore redundant. However, code is below

firstorder.mod.re <- glmer(Data.Deficient ~ Deepwater + Coastal + Pelagic + Benthic + BrackishFreshwater + 
      Tropical + Temperate + 
      Global + Pacific + Atlantic + Indian + Arctic + Antarctic + Trans.oceanic +
      Fisheries + commercial + subsistence + Gamefish + Aquarium + Vulnerability + 
      log_size + Rep_Strategy +
        (1|Order), data = dd, family = "binomial")


```
### Now to visualize a coefficient plots to see what is significant!

```{r}
# Pull out plot data
coefs <- plot_model(firstorder.mod, transform = NULL)

# Making custom figure
coefs$data %>%
  mutate(term = factor(term, levels = term)) %>%
  # Color by sign of change, transparency by p-value
  ggplot(aes(x = estimate,
             y = as.numeric(term),
             color = as.factor(sign(estimate)),
             alpha = as.factor(p.value < 0.05))) +
  geom_point() + 
  # Add CIs around point
  geom_segment(aes(x = conf.low,
                   xend  = conf.high,
                   yend = as.numeric(term))) +
  geom_vline(xintercept = 0) +
  # Adding labelled y axis
  scale_y_continuous(labels = as.character(coefs$data$term),
                     breaks = seq(1, 27, 1)) +
  scale_alpha_discrete(range = c(.5, 1)) +
  xlab("Log Odds Ratio of Being DD (Higher Values = Greater Chance)") +
  ylab("Variables")
```

# Results  
Here we see a few significant relationships:  

*Biology*  
**Size** negative correlation with DD  
Reproductive strategy  

*Human Use*  
Human use in general (any use)  
**Vulnerability** positive correlation with DD  
**Type of fishery** (**commercial - negative correlation**, gamefish, aquaculture)  


*Ecology*  
**Geographic range** positive corr. with Arctic Ocean (note small sample size); negative corr. with Indian Ocean   
Latitude/temperature (tropical/temperate)  
**Habitat** (**benthic - positive correlation**, deepwater, pelagic, coastal, **freshwater - negative correlation**)  
**Depth range** (**0-200 m - negative correlation**, 201-1000 m, **1000+ m- negative correlation**)  

*Let's summarize what this all means. In general, we are seeing that larger sharks are less likely to be data deficient, as are species targeted by fisheries specifically, rather than just human use in general. In terms of habitat, sharks are less likely to be data deficient if they are found in the Indian Ocean, in freshwater, and either in the photic zone or at depths of greater than 1000 m. Note that there may be an influence of sample size in some of these cases.*  

*In contrast, highly vulnerable species are more likely to be data deficient. Sharks in the Arctic are also more likely to be data deficient, although we have a small sample size for this. Interestingly, although sharks at depths of greater than 1000 m are LESS likely to be data deficient, benthic species are likely to be. These two characteristics are not necessarily correlated, as benthic species could reside at all depths, depending on whether they are coastal or deep water.*  


### Let's visualize our significant results

```{r}

# We will need to backtransform in order to get the relationships on the real scale, rather than the transformed scale

## subset coefficients by category

# We will need to backtransform in order to get the relationships on the real scale, rather than the transformed scale

## subset coefficients by category
fullcoeffs <- summary(firstorder.mod)$coefficients %>% as.data.frame(.) %>% rownames_to_column()
coef_conf <- confint(firstorder.mod) %>% as.data.frame(.) %>% rownames_to_column()

coef_table <- left_join(fullcoeffs, coef_conf) %>%
  rename("Coef" = "rowname")

#size_coeffs <- fullcoeffs[c("log_size"),]
#size_coeffs
#vuln_coeffs <- plogis(fullcoeffs[c("Vulnerability"),])

########### Evan's Help ####
library(emmeans)

logsize_means <- emmeans(firstorder.mod, ~ log_size, 
         var = "log_size", 
         at = list(log_size = seq(2, 8, by = .25)),
         type = "response")

# Plotting the figure
data.frame(logsize_means) %>%
  ggplot(aes(x = exp(log_size), # Exponentiating log size
             y = prob)) +
  geom_ribbon(aes(ymin = asymp.LCL,
              ymax = asymp.UCL),
              alpha = .2) +
  geom_line() +
  theme_bw()
 
vulnerability_means <- emmeans(firstorder.mod, ~ Vulnerability, 
         var = "Vulnerability", 
         at = list(Vulnerability = seq(0, 4)),
         type = "response")

data.frame(vulnerability_means) %>%
  ggplot(aes(x = Vulnerability,
             y = prob,
             group = Vulnerability,
             ymin = asymp.LCL,
             ymax = asymp.UCL)) +
  geom_point() +
  geom_errorbar(width = .1)+
  theme_bw()

```


```{r}
### Plot backtransformed values against all values of size in this data set (dd$Size vs. )

#### Habitat
hab_coeffs <- plogis(fullcoeffs[c("Benthic", "Deepwater", "Pelagic", "Coastal", "BrackishFreshwater"),])
barplot(hab_coeffs[,"Estimate"], ylab="Relative Probability of Data Deficiency")

# OR! 

hab_coeffs.2 <- fullcoeffs[c("Benthic", "Deepwater", "Pelagic", "Coastal", "BrackishFreshwater"),]
barplot(hab_coeffs.2[,"Estimate"], ylab="Log Odds Ratio of Data Deficiency")


### Geography
geo_coeffs <- plogis(fullcoeffs[c("Atlantic", "Arctic", "Global", "Indian", "Pacific", "Global"),]) #note that this is a matrix
barplot(geo_coeffs[,"Estimate"], ylab="Relative Probability of Data Deficiency")

geo_coeffs.2 <- fullcoeffs[c("Atlantic", "Arctic", "Global", "Indian", "Pacific", "Global"),] #note that this is a matrix
barplot(geo_coeffs.2[,"Estimate"], ylab="Log Odds Ratio of Data Deficiency")


### Depth range
depth_coeffs <- plogis(fullcoeffs[c("D11", "D21", "D31"),])
depth_coeffs
barplot(depth_coeffs[,"Estimate"], names.arg=c("0-200m", "201-1000m", "1000+"), horiz=TRUE, xlab="Relative Probability of Data Deficiency", ylab="Depth")

depth_coeffs.2 <- fullcoeffs[c("D11", "D21", "D31"),]
barplot(depth_coeffs.2[,"Estimate"], names.arg=c("0-200m", "201-1000m", "1000+"), horiz=TRUE, xlab="Log Odds Ratio of Data Deficiency", ylab="Depth")

```

